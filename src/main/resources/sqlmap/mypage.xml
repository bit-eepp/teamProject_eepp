<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bit.team.eepp.Mapper.UserMapper">

<select id = "scrapList" parameterType="int" resultType="bit.team.eepp.VO.ScrapVO">
	<![CDATA[
		SELECT s.sId, s.sDate, s.user_id, s.board_id, b.bTitle, u.uNickname FROM SCRAP s, BOARD b, USERS u
		WHERE b.bId = s.board_id AND s.user_id = u.user_id AND s.user_id= #{user_id}
		ORDER BY s.sDate DESC
		]]>
</select>

	<!-- 회원 탈퇴 -->
	<delete id="withdrawal">
	<![CDATA[
		delete from users where USER_ID = #{user_id}
		]]>
	</delete>
	<!-- 스크랩 개수 -->
	<select id="scrapCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(sId) FROM scrap s, USERS u WHERE u.user_id = #{user_id} and s.user_id = #{user_id} AND sId > 0
		]]>
	</select>
	<!--  댓글 개수 -->
	<select id="replyCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(rpid) FROM reply r, USERS u WHERE u.USER_ID = #{user_id} and r.USER_ID = #{user_id} AND rpid > 0
		]]>
	</select>
	<!-- 게시글 총 개수 -->
	<select id="listCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(bId) FROM BOARD b, USERS u WHERE u.USER_ID = #{user_id} and b.USER_ID = #{user_id} AND bId > 0
		]]>
		<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

		<if test="mscri != null">
			<choose>
				<when test='mscri.searchType == "w"'>
					AND uNickname LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "t"'>
					AND bTitle LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "c"'>
					AND bContent LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "tc"'>
					AND (bTitle LIKE '%' || #{mscri.keyword} || '%' OR
					bContent LIKE '%' || #{mscri.keyword} || '%')
				</when>
			</choose>
		</if>
	</select>

	<select id="myBoardList" resultType="bit.team.eepp.VO.BoardVO" parameterType="map">
		SELECT * FROM
		(SELECT A.*, ROWNUM AS RNUM, COUNT(*) OVER() AS TOTCNT
		FROM
		(SELECT b.bId, b.bCategory, b.bSubject, b.bTitle, bContent,
		u.uNickname, b.bWrittenDate, b.bModifyDate, b.bHit, b.bLike,
		b.bUnlike,
		(SELECT COUNT(*)FROM REPLY WHERE board_id = b.bId) AS
		rpCount, (SELECT COUNT(*) FROM DECLARATION WHERE board_id = b.bId) AS
		dCount
		FROM USERS u, BOARD b WHERE u.USER_ID = #{user_id} and b.USER_ID
		= #{user_id}

		<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

		<if test="mscri != null">
			<choose>
				<when test='mscri.searchType == "w"'>
					AND uNickname LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "t"'>
					AND bTitle LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "c"'>
					AND bContent LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "tc"'>
					AND (bTitle LIKE '%' || #{mscri.keyword} || '%' OR
					bContent LIKE '%' || #{mscri.keyword} || '%')
				</when>
			</choose>
		</if>

		ORDER BY b.bwrittendate DESC) A)
		WHERE RNUM BETWEEN #{mscri.rowStart} AND #{mscri.rowEnd}
	</select>

	<!-- <select id="selectOne" resultType="bit.team.eepp.VO.BoardVO">
		SELECT b.bId, b.bCategory,
		b.bSubject, b.bTitle, bContent, u.uNickname, b.bWrittenDate,
		b.bModifyDate, b.bHit, b.bLike, b.bUnlike, (SELECT COUNT(*)FROM REPLY
		WHERE board_id = b.bId) AS rpCount
		FROM USERS u, BOARD b WHERE
		u.USER_ID = b.USER_ID AND bId = #{bId}
	</select>

	<update id="hitUp" parameterType="bit.team.eepp.VO.BoardVO">
		UPDATE BOARD SET bHit = bHit +
		1 WHERE bId = #{bId}
	</update>

	<insert id="write" parameterType="bit.team.eepp.VO.BoardVO">
		<selectKey keyProperty="boardVO.bId" resultType="int"
			order="BEFORE">
			SELECT BOARD_SEQ.nextval FROM DUAL
		</selectKey>

		INSERT INTO BOARD (bId, user_id, bTitle, bContent, bSubject,
		bCategory, bWrittenDate, bModifyDate, bHit, bLike, bUnlike, bBlind)
		VALUES(#{boardVO.bId}, #{boardVO.user_id}, #{boardVO.bTitle},
		#{boardVO.bContent}, #{boardVO.bSubject}, #{boardVO.bCategory},
		SYSDATE, SYSDATE, 0, 0, 0,'no')
	</insert>

	<delete id="delete" parameterType="bit.team.eepp.VO.BoardVO">
		DELETE FROM BOARD WHERE bId =
		#{bId}
	</delete>

	<select id="modifyView" resultType="bit.team.eepp.VO.BoardVO">
		SELECT b.bId, b.bCategory,
		b.bSubject, b.bTitle, b.bContent, u.uNickname, b.bWrittenDate,
		b.bModifyDate, b.bHit, b.bLike, b.bUnlike FROM USERS u, BOARD b WHERE
		u.USER_ID = b.USER_ID AND bId = #{bId}
	</select>

	<update id="modify" parameterType="bit.team.eepp.VO.BoardVO">
		UPDATE BOARD SET bTitle =
		#{boardVO.bTitle}, bContent = #{boardVO.bContent}, bModifyDate =
		SYSDATE WHERE bId = #{boardVO.bId}
	</update>

 -->
</mapper>
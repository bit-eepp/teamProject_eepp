<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bit.team.eepp.Mapper.UserMapper">

	<!-- 댓글 신고 -->
	<select id="rep_Declaration"
		resultType="bit.team.eepp.VO.DeclarationVO" parameterType="int">
	<![CDATA[
	select d.did, d.reporter_id, d.reported_id, d.dreason, d.ddate, d.reply_id
from reply r,declaration d, users u
where d.reply_id = r.rpid and d.reporter_id = u.user_id
	]]>
	</select>

	<!-- 게시물 신고 -->
	<select id="declaration"
		resultType="bit.team.eepp.VO.DeclarationVO" parameterType="int">
	<![CDATA[
	select d.did, d.reporter_id, d.reported_id, d.dreason, d.ddate,
	d.board_id, b.btitle, d.reply_id from board b,declaration d, users u
	where d.board_id = b.bid and d.reporter_id = u.user_id
	]]>
	</select>

	<!-- 메세지 받은 목록 -->
	<select id="receiveCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(*) FROM message m, users u WHERE u.USER_ID = m.sender_ID AND receiver_id = #{user_id}
		]]>
	</select>

	<!-- 메세지 보낸 목록 -->
	<select id="sendCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(*) FROM message m, users u WHERE u.USER_ID = m.receiver_ID AND sender_id = #{user_id}
		]]>
	</select>
	<!-- 스크랩 목록 -->
	<select id="scrapList" parameterType="int"
		resultType="bit.team.eepp.VO.ScrapVO">
		
			SELECT * FROM (SELECT A.*, ROWNUM AS RNUM, COUNT(*) OVER() AS TOTCNT
from(select s.sId, s.sDate, s.user_id, s.board_id, b.bTitle, u.uNickname as tester FROM SCRAP s, BOARD b, USERS u
			WHERE b.bId = s.board_id AND s.user_id = u.user_id AND s.user_id= #{user_id}
			<!-- ORDER BY s.sDate DESC -->
			<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

		ORDER BY s.sDate DESC) A)
		WHERE RNUM BETWEEN #{scrapcri.rowStart}
		AND #{scrapcri.rowEnd}
		
	</select>

	<!-- 회원 탈퇴 -->
	<delete id="withdrawal">
	<![CDATA[
		delete from users where USER_ID = #{user_id}
		]]>
	</delete>
	<!-- 스크랩 개수 -->
	<select id="scrapCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(sId) FROM scrap s, USERS u WHERE u.user_id = #{user_id} and s.user_id = #{user_id} AND sId > 0
		]]>
		<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

	</select>
	<!-- 댓글 개수 -->
	<select id="replyCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(rpid) FROM reply r, USERS u WHERE u.USER_ID = #{user_id} and r.USER_ID = #{user_id} AND rpid > 0
		]]>
	</select>
	<!-- 게시글 총 개수 -->
	<select id="listCount" resultType="int" parameterType="map">
		<![CDATA[
			SELECT COUNT(bId) FROM BOARD b, USERS u WHERE u.USER_ID = #{user_id} and b.USER_ID = #{user_id} AND bId > 0
		]]>
		<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

		<if test="mscri != null">
			<choose>
				<when test='mscri.searchType == "w"'>
					AND uNickname LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "t"'>
					AND bTitle LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "c"'>
					AND bContent LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "tc"'>
					AND (bTitle LIKE '%' || #{mscri.keyword} || '%' OR
					bContent LIKE '%' || #{mscri.keyword} || '%')
				</when>
			</choose>
		</if>
	</select>

	<select id="myBoardList" resultType="bit.team.eepp.VO.BoardVO"
		parameterType="map">
		SELECT * FROM
		(SELECT A.*, ROWNUM AS RNUM, COUNT(*) OVER() AS TOTCNT
		FROM
		(SELECT b.bId, b.bCategory, b.bSubject, b.bTitle, bContent,
		u.uNickname, b.bWrittenDate, b.bModifyDate, b.bHit, b.bLike,
		b.bUnlike,
		(SELECT COUNT(*)FROM REPLY WHERE board_id = b.bId) AS
		rpCount, (SELECT COUNT(*) FROM DECLARATION WHERE board_id = b.bId) AS
		dCount
		FROM USERS u, BOARD b WHERE u.USER_ID = #{user_id} and b.USER_ID
		= #{user_id}

		<if test="bCategory != null">
			<choose>
				<when test="bCategory == 'notice'">
					AND b.bCategory = 'notice'
				</when>
				<when test="bCategory == 'it_dev'">
					AND b.bCategory = 'it_dev'
				</when>
				<when test="bCategory == 'service'">
					AND b.bCategory = 'service'
				</when>
				<when test="bCategory == 'finance'">
					AND b.bCategory = 'finance'
				</when>
				<when test="bCategory == 'design'">
					AND b.bCategory = 'design'
				</when>
				<when test="bCategory == 'official'">
					AND b.bCategory = 'official'
				</when>
				<when test="bCategory == 'etc'">
					AND b.bCategory = 'etc'
				</when>
			</choose>
		</if>

		<if test="mscri != null">
			<choose>
				<when test='mscri.searchType == "w"'>
					AND uNickname LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "t"'>
					AND bTitle LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "c"'>
					AND bContent LIKE '%' || #{mscri.keyword} || '%'
				</when>
				<when test='mscri.searchType == "tc"'>
					AND (bTitle LIKE '%' || #{mscri.keyword} || '%' OR
					bContent LIKE '%' || #{mscri.keyword} || '%')
				</when>
			</choose>
		</if>

		ORDER BY b.bwrittendate DESC) A)
		WHERE RNUM BETWEEN #{mscri.rowStart}
		AND #{mscri.rowEnd}
	</select>
</mapper>
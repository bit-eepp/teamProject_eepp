<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bit.team.eepp.Mapper.EatingMapper">
	<select id="eatingListCount" resultType="int"
		parameterType="map">
		<![CDATA[
			SELECT COUNT(eId) FROM eating where eId>0
		]]>

		<if test="eCategory != null">
			<choose>
				<when test="eCategory == 'american_food'">
					AND eCategory = 'american_food'
				</when>
				<when test="eCategory == 'korean_food'">
					AND eCategory = 'korean_food'
				</when>
				<when test="eCategory == 'japaneses_food'">
					AND eCategory = 'japaneses_food'
				</when>
				<when test="eCategory == 'chinese_food'">
					AND eCategory = 'chinese_food'
				</when>
				<when test="eCategory == 'asian_food'">
					AND eCategory = 'asian_food'
				</when>
				<when test="eCategory == 'etc'">
					AND eCategory = 'etc'
				</when>
			</choose>
		</if>

		<!-- 내용과 제목으로만 검색 -->
		<if test="escri != null">
			<choose>
				<when test='escri.searchType == "t"'>
					AND eTitle LIKE '%' || #{escri.keyword} || '%'
				</when>
				<when test='escri.searchType == "c"'>
					AND eContent LIKE '%' || #{escri.keyword} || '%'
				</when>
			</choose>
		</if>
	</select>

	<select id="eatingList" resultType="bit.team.eepp.VO.EatingVO"
		parameterType="map">
		SELECT * FROM
		(SELECT A.*, ROWNUM AS RNUM, COUNT(*) OVER() AS TOTCNT FROM
		(SELECT eID, eTITLE, eADDRESS_new, eADDRESS_old, eTEL, eCONTENT, eMAP_1,
		eMAP_2, eSEARCH_1, eSEARCH_2, eSEARCH_3, eGrade
		FROM Eating where eId > 0

		<if test="eCategory != null">
			<choose>
				<when test="eCategory == 'american_food'">
					AND eCategory = 'american_food'
				</when>
				<when test="eCategory == 'korean_food'">
					AND eCategory = 'korean_food'
				</when>
				<when test="eCategory == 'japaneses_food'">
					AND eCategory = 'japaneses_food'
				</when>
				<when test="eCategory == 'chinese_food'">
					AND eCategory = 'chinese_food'
				</when>
				<when test="eCategory == 'asian_food'">
					AND eCategory = 'asian_food'
				</when>
				<when test="eCategory == 'etc'">
					AND eCategory = 'etc'
				</when>
			</choose>
		</if>

		<if test="escri != null">
			<choose>
				<when test='escri.searchType == "t"'>
					AND eTitle LIKE '%' || #{escri.keyword} || '%'
				</when>
				<when test='escri.searchType == "c"'>
					AND eContent LIKE '%' || #{escri.keyword} || '%'
				</when>
			</choose>
		</if>

		ORDER BY

		<choose>
			<when test="sortType == 'eDate'">
				eDate
			</when>
		</choose>

		DESC) A)
		WHERE RNUM BETWEEN #{escri.rowStart} AND #{escri.rowEnd}
	</select>
	
	<!-- !!!! 차후 해당 쿼리 수정 필!!!!! -->
	<select id="selectOne" resultType="bit.team.eepp.VO.EatingVO">
		SELECT eId, eTitle, eCategory, eDate, eContent, eTel, eAddress_new,
		eAddress_old, eGrade, eMap_1, eMap_2, eSearch_1, eSearch_2, eSearch_3,
		eReview,
		(SELECT COUNT(*)FROM REVIEW WHERE eId = eId) AS rvCount
		FROM EATING WHERE eId = #{eId}
	</select>
	
	<!-- <update id="hitUp" parameterType="bit.team.eepp.VO.EatingVO"> UPDATE 
		BOARD SET bHit = bHit + 1 WHERE bId = #{bId} </update> -->
		
	<insert id="write" parameterType="bit.team.eepp.VO.EatingVO">
		<selectKey keyProperty="eatingVO.eId" resultType="int"
			order="BEFORE">
			SELECT EATING_SEQ.nextval FROM DUAL
		</selectKey>

		INSERT INTO EATING (e.eID, e.eTITLE, e.eCATEGORY, e.eDATE, e.eCONTENT,
		e.eTEL, e.eADDRESS_new, e.eADDRESS_old, e.eGRADE,e.eMAP_1, e.eMAP_2,
		e.eSEARCH_1, e.eSEARCH_2, e.eSEARCH_3)
		VALUES(#{eatingVO.eId},
		#{eatingVO.user_id}, #{eatingVO.eTitle}, #{eatingVO.eCATEGORY},
		SYSDATE, #{eatingVO.eCONTENT}, #{eatingVO.eTEL},
		#{eatingVO.eADDRESS_new}, #{eatingVO.eADDRESS_old}, '', '', '')
	</insert>

	<delete id="delete" parameterType="bit.team.eepp.VO.EatingVO">
		DELETE FROM EATING WHERE eId =
		#{eId}
	</delete>

	<select id="modifyView" resultType="bit.team.eepp.VO.EatingVO">
		SELECT e.eId, e.eTitle,
		e.eCategory, e.eDate, e.eContent, e.eTel, e.eAddress_new,
		e.eAddress_old, e.eGrade, e.eMap_1, e.eMap_2, e.eSearch_1,
		e.eSearch_2, e.eSearch_3, e.eReview FROM USERS u, EATING e WHERE
		u.USER_ID = e.USER_ID AND eId = #{eId}
	</select>

	<update id="modify" parameterType="bit.team.eepp.VO.EatingVO">
		UPDATE EATING SET eTitle =
		#{eatingVO.eTitle}, eContent = #{eatingVO.eContent}, eDate = SYSDATE
		WHERE eId = #{eatingVO.eId}
	</update>

	<!-- <select id="noticeList" resultType="bit.team.eepp.VO.EatingVO"> <![CDATA[ 
		SELECT * FROM ( SELECT b.bId, b.bCategory, b.bSubject, b.bTitle, bContent, 
		u.uNickname, b.bWrittenDate, b.bHit, b.bLike, b.bUnlike, (SELECT COUNT(*)FROM 
		REPLY WHERE board_id = b.bId) AS rpCount FROM USERS u, BOARD b WHERE u.USER_ID 
		= b.USER_ID AND b.bCategory = 'notice' ORDER BY bWrittenDate DESC) WHERE 
		ROWNUM <= 2 ]]> </select> <select id="hotList" resultType="bit.team.eepp.VO.BoardVO"> 
		<![CDATA[ SELECT * FROM ( SELECT b.bId, b.bCategory, b.bSubject, b.bTitle, 
		bContent, u.uNickname, b.bWrittenDate, b.bHit, b.bLike, b.bUnlike, (SELECT 
		COUNT(*) FROM REPLY WHERE board_id = b.bId) AS rpCount, (SELECT COUNT(*) 
		FROM DECLARATION WHERE board_id = b.bId) AS dCount FROM USERS u, BOARD b 
		WHERE u.USER_ID = b.USER_ID AND TO_CHAR(b.bWrittenDate,'YYYYMMDD') = TO_CHAR(SYSDATE,'YYYYMMDD') 
		ORDER BY rpCount DESC) WHERE dCount <= 10 AND ROWNUM <= 3 ]]> </select> -->
</mapper>